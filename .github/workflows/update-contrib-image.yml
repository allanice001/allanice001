name: Update contribution image in README

on:
  schedule:
    - cron: "13 08 * * *" # daily ~08:13 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render-graphql:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20.2.0

      - name: Generate SVG from GitHub GraphQL
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: ${{ github.repository_owner }}
        run: |
          cat > script.mjs << 'EOF'
          import fs from 'node:fs/promises';

          const query = `
          query($login:String!) {
            user(login:$login) {
              contributionsCollection {
                contributionCalendar {
                  totalContributions
                  weeks {
                    contributionDays { color contributionCount date }
                  }
                }
              }
            }
          }`;

          const resp = await fetch('https://api.github.com/graphql', {
            method: 'POST',
            headers: {
              'Authorization': `bearer ${process.env.GH_TOKEN}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query, variables: { login: process.env.USERNAME }})
          });

          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`GraphQL HTTP ${resp.status}: ${text}`);
          }
          const json = await resp.json();
          if (json.errors) throw new Error(JSON.stringify(json.errors, null, 2));
